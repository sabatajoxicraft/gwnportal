-- ========================================================
-- Seed voucher_logs with real GWN vouchers for autolink test
-- ========================================================
-- This assigns one unique used/inuse voucher per student
-- for the current month, ready for auto_link_devices.php

-- Month context
SET @month_iso = DATE_FORMAT(CURDATE(), '%Y-%m');
SET @month_label = DATE_FORMAT(CURDATE(), '%M %Y');

-- 1) Voucher list (real used/inuse vouchers from GWN)
DROP TEMPORARY TABLE IF EXISTS tmp_vouchers;
CREATE TEMPORARY TABLE tmp_vouchers (
  voucher_code VARCHAR(50) NOT NULL,
  gwn_group_id INT NOT NULL
);

INSERT INTO tmp_vouchers (voucher_code, gwn_group_id) VALUES
('16533202223', 245938),
('16533702222', 245938),
('19513402221', 245938),
('11513802220', 245938),
('14533002219', 245938),
('18583602218', 245938),
('13583102216', 245938),
('14593202215', 245938),
('11593402213', 245938),
('12593002212', 245938),
('17573502210', 245938),
('13503902209', 245938),
('18513702208', 245938),
('16553802207', 245938),
('14583702205', 245938),
('12563802134', 245938),
('17503102132', 245938),
('19583402131', 245938),
('12583202130', 245938),
('17543002129', 245938),
('18573302128', 245938),
('18553602126', 245938),
('13583302125', 245938),
('15523502124', 245938),
('12593701812', 245934),
('15439946061', 241669),
('12469646059', 241669),
('12469346057', 241669),
('14489846054', 241669),
('14419546051', 241669),
('11459946049', 241669),
('12449646047', 241669),
('18449746041', 241669),
('10429246040', 241669),
('16499546036', 241669),
('18469746035', 241669),
('16409346033', 241669),
('11489546032', 241669),
('13479646031', 241669),
('17409046030', 241669),
('15459446029', 241669),
('12439446028', 241669),
('19449546027', 241669),
('13429946026', 241669),
('19469746025', 241669),
('18489446024', 241669),
('14409746023', 241669),
('18429746022', 241669),
('11419846021', 241669),
('11489646020', 241669),
('13459046019', 241669),
('16439746018', 241669),
('16489146017', 241669),
('15459646016', 241669),
('14479046015', 241669),
('19439446014', 241669),
('14429146013', 241669),
('19469646012', 241669),
('19449946011', 241669),
('11409046010', 241669),
('13499946009', 241669),
('10479546008', 241669),
('11439046007', 241669),
('16499246006', 241669),
('16489146005', 241669),
('19439546004', 241669),
('19449746003', 241669),
('19499846002', 241669),
('13439246001', 241669),
('11499146000', 241669),
('11469145999', 241669),
('18439845998', 241669),
('15429645997', 241669),
('13439845996', 241669),
('13449545995', 241669),
('17459045994', 241669),
('12459245993', 241669),
('19429245992', 241669),
('15449245991', 241669),
('19459445990', 241669),
('10419745989', 241669),
('11429245988', 241669),
('14489045987', 241669),
('11429045986', 241669),
('12469245985', 241669),
('12449545984', 241669),
('12409245983', 241669),
('19479045982', 241669),
('18419645981', 241669),
('11499145980', 241669),
('12469345979', 241669),
('17469745978', 241669),
('17469245977', 241669),
('19439345976', 241669),
('10469145975', 241669),
('15499545973', 241669),
('18489945971', 241669),
('13469845969', 241669),
('10409145968', 241669),
('16469245965', 241669),
('12429745963', 241669),
('16409945961', 241667),
('18409645959', 241667),
('19439945958', 241667),
('13419045957', 241667),
('17439945956', 241667),
('18449545954', 241667),
('14429445953', 241667),
('13439445952', 241667),
('12409745951', 241667),
('17469845950', 241667),
('10449345949', 241667),
('12499645947', 241667),
('19419745946', 241667),
('17479945945', 241667),
('12419245944', 241667),
('12419145943', 241667),
('13419845942', 241667),
('17469245937', 241667),
('16489245936', 241667),
('14409045934', 241667),
('11489545932', 241667),
('12459645929', 241667),
('17469245927', 241667),
('13439045917', 241667),
('13479945916', 241667),
('11439145915', 241667),
('15459645914', 241667),
('16419445909', 241667),
('10409245908', 241667),
('16419345906', 241667),
('18479745905', 241667),
('17429345904', 241667),
('18479745903', 241667),
('18419045902', 241667),
('15409645901', 241667),
('16409745900', 241667),
('12479945899', 241667),
('16499945898', 241667),
('15419445897', 241667),
('18489745896', 241667),
('13429245895', 241667),
('15449745894', 241667),
('14499745893', 241667),
('13499145892', 241667),
('14409445891', 241667),
('15469845890', 241667),
('12439545889', 241667),
('16479645888', 241667),
('13429445887', 241667),
('17459745885', 241667),
('17419545884', 241667),
('12479745883', 241667),
('17449345882', 241667),
('19489745881', 241667),
('11479445880', 241667),
('19459245879', 241667),
('15409645878', 241667),
('15419745877', 241667),
('18439445876', 241667),
('15419445875', 241667),
('16499045874', 241667),
('14439245873', 241667),
('15439145872', 241667),
('10499845871', 241667),
('16429245870', 241667),
('10469845869', 241667),
('18439545868', 241667),
('10469545867', 241667),
('18499745866', 241667),
('12469745865', 241667),
('11409945864', 241667),
('19459545863', 241667),
('13449645862', 241667),
('16489145020', 241639),
('19419545000', 241639),
('18419344999', 241639),
('11479644993', 241639),
('14459744992', 241639),
('12419844991', 241639),
('11439544990', 241639),
('13459044989', 241639),
('11419244984', 241639),
('10409944983', 241639),
('16499744982', 241639),
('16459644981', 241639),
('15439544979', 241639),
('11449344977', 241639),
('16409544976', 241639),
('11459144975', 241639),
('10479444974', 241639),
('14469644973', 241639),
('13439144972', 241639),
('14499344971', 241639),
('11469144970', 241639),
('14459444968', 241639),
('15469144967', 241639),
('16419144966', 241639),
('12429944965', 241639),
('10429844964', 241639),
('10499444962', 241639),
('16439944961', 241639),
('19489744960', 241639),
('17409044959', 241639),
('12409844958', 241639),
('15409344957', 241639),
('11459544956', 241639),
('16479844955', 241639),
('13479544954', 241639),
('13459044953', 241639),
('16419044952', 241639),
('15409444951', 241639),
('18489344950', 241639),
('18469744949', 241639),
('19429244948', 241639),
('12489744947', 241639),
('12499144946', 241639),
('16479944945', 241639),
('15449944944', 241639),
('18419944943', 241639),
('19469744942', 241639),
('11479944941', 241639),
('11499844940', 241639),
('14469344939', 241639),
('10489944938', 241639),
('16439244937', 241639),
('11469644936', 241639),
('19449444935', 241639),
('12419844934', 241639),
('14469244933', 241639),
('12469144932', 241639),
('16489544931', 241639),
('10449844930', 241639),
('16499844929', 241639),
('16469244928', 241639),
('19489444927', 241639),
('14439144926', 241639),
('19439644925', 241639),
('13409844924', 241639),
('17469244923', 241639),
('14449544922', 241639),
('13469744921', 241639);

-- 2) Students list (all students)
DROP TEMPORARY TABLE IF EXISTS tmp_students;
CREATE TEMPORARY TABLE tmp_students AS
SELECT u.id AS user_id,
       ROW_NUMBER() OVER (ORDER BY u.id) AS rn
FROM users u
JOIN roles r ON r.id = u.role_id
WHERE r.name = 'student';

-- 3) Rank vouchers
DROP TEMPORARY TABLE IF EXISTS tmp_voucher_rank;
CREATE TEMPORARY TABLE tmp_voucher_rank AS
SELECT voucher_code,
       gwn_group_id,
       ROW_NUMBER() OVER (ORDER BY gwn_group_id, voucher_code) AS rn
FROM tmp_vouchers;

-- 4) Check counts (ensure vouchers >= students)
SELECT
  (SELECT COUNT(*) FROM tmp_students) AS student_count,
  (SELECT COUNT(*) FROM tmp_voucher_rank) AS voucher_count;

-- 5) Clear current-month voucher logs for students
DELETE FROM voucher_logs
WHERE user_id IN (SELECT user_id FROM tmp_students)
  AND (voucher_month = @month_iso OR voucher_month = @month_label OR DATE_FORMAT(created_at, '%Y-%m') = @month_iso);

-- 6) Insert new voucher logs (one voucher per student)
INSERT INTO voucher_logs (user_id, voucher_code, voucher_month, sent_via, status, sent_at, created_at, gwn_group_id, is_active)
SELECT s.user_id,
       v.voucher_code,
       @month_iso,
       'SMS',
       'sent',
       NOW(),
       NOW(),
       v.gwn_group_id,
       1
FROM tmp_students s
JOIN tmp_voucher_rank v ON v.rn = s.rn;

-- 7) Verify assignment
SELECT 
  u.id AS user_id,
  CONCAT(u.first_name, ' ', u.last_name) AS student_name,
  vl.voucher_code,
  vl.gwn_group_id,
  vl.voucher_month
FROM voucher_logs vl
JOIN users u ON u.id = vl.user_id
WHERE vl.voucher_month = @month_iso
ORDER BY u.id
LIMIT 20;

SELECT CONCAT('âœ“ Assigned ', COUNT(*), ' vouchers to students for ', @month_iso) AS summary
FROM voucher_logs
WHERE voucher_month = @month_iso;
